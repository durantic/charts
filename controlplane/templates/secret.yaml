apiVersion: v1
kind: Secret
metadata:
  name: {{ include "durantic.fullname" . }}
  labels:
    {{- include "durantic.labels" . | nindent 4 }}
  annotations:
    "helm.sh/resource-policy": "keep"
type: Opaque
data:
  # Django secret key - auto-generated if not provided
  django-secret-key: {{ include "durantic.djangoSecretKey" . | b64enc | quote }}
  
  {{- if and (not .Values.postgresql.enabled) (not .Values.django.database.existingSecret) }}
  # Database password - required when not using PostgreSQL subchart and no existing secret
  database-password: {{ include "durantic.databasePassword" . | b64enc | quote }}
  {{- end }}

  {{- if and (not .Values.redis.enabled) (or (not .Values.django.redis.existingSecret) (eq .Values.django.redis.existingSecret "")) }}
  # Redis password - required when not using Redis subchart and no existing secret
  redis-password: {{ include "durantic.redisPassword" . | b64enc | quote }}
  {{- end }}
  
  {{- if .Values.django.email.user }}
  # Email credentials
  email-user: {{ .Values.django.email.user | b64enc | quote }}
  email-password: {{ .Values.django.email.password | b64enc | quote }}
  {{- end }}
  
  
  # JWE Key for JWT encryption
  jwe-key: {{ include "durantic.jweKey" . | b64enc | quote }}

  {{- if .Values.certificates.ca.generate }}
  {{- $caData := include "durantic.generateOrLookupCA" . | splitList "|" }}
  # Auto-generated CA certificate and key for mTLS
  ca.crt: {{ index $caData 0 | b64enc | quote }}
  ca.key: {{ index $caData 1 | b64enc | quote }}
---
# Client CA secret for ingress-nginx mTLS validation
# Contains only the public CA certificate (no private key)
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "durantic.fullname" . }}-client-ca
  labels:
    {{- include "durantic.labels" . | nindent 4 }}
  annotations:
    "helm.sh/resource-policy": "keep"
type: Opaque
data:
  ca.crt: {{ index $caData 0 | b64enc | quote }}
  {{- end }}